<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>scoby.page - Turn any Are.na channel into a website</title>
        <meta name="description" content="Turn any Are.na channel into a website.">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <link rel="shortcut icon" type="image/png" href="images/favicon.png">
        <link href="css/home.css?v=1.0" rel="stylesheet">

        <!-- social -->
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Scoby">
        <meta name="twitter:description" content="Create pages with Are.na">
        <meta name="twitter:image" content="https://scoby.page/images/social.jpg">
    </head>
        
    <body>

        <main id="home">
            <div id="welcome">
                <h1>s<span style="color: #950b91;">c</span><span style="color: #69d418;">o</span><span style="color: #c24d0a;">b</span>y.<span style="color: #83950b;">p</span><span style="color: #0b2b95;">a</span><span style="color: #000;">g</span><span style="color: #d319cc;">e</span></h1>
    
                <p>Turn any <span style="color: #208512;">open</span> or <span style="color: #e12727;">closed</span> <a href="https://are.na">Are.na</a> channel into a <span style="color: #1d20c3;">website</span>.</p>
                    
                <p style="margin-top: 10px;">Style your Scoby by adding a block titled "stylesheet" with some CSS to your channel.</p>

                <p>Watch a <a href="https://attachments.are.na/35793145/2ec685d4a88d3f6fac11de8803d57144.mp4">short tutorial</a>.</p>

                <p>Please consider <a href="https://www.patreon.com/c/elliottcost">supporting</a> this project. Made by <a href="https://elliott.computer">Elliott Cost</a>.</p>
    
            </div>

            <h2><button id='refresh-cache'>Refresh list</button></h2>

            <div id="scobies">
            </div>

            <div id='loading'>Loading scobies...</div>
            
            <div style="margin: 12px 0;">
                <button id='load-more'>Load more</button>
            </div>

        </main>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const channelName = 'scoby';
                const api = 'https://api.are.na/v2/channels/';
                const backend = '/api/sites/all';
                let allChannels = [];
                let displayedCount = 0;
                const perPage = 64; // Number of channels to display initially
                const loadMoreBtn = document.getElementById('load-more');
                const loadingEl = document.getElementById('loading');
                const scobiesEl = document.getElementById('scobies');
                
                async function loadAllChannels(useBackend = true, refresh = false) {
                    try {
                        allChannels = [];
                        displayedCount = 0;
                        scobiesEl.innerHTML = '';
                        loadingEl.classList.remove('done-loading');

                        if (useBackend) {
                            const url = refresh ? `${backend}?refresh=1` : backend;
                            const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
                            if (!r.ok) throw new Error(`Backend request failed: ${r.status}`);
                            const data = await r.json();
                            if (Array.isArray(data.contents)) {
                                allChannels = data.contents;
                            }
                        } else {
                            // Fallback to direct Are.na
                            const initialResponse = await fetch(`${api}${channelName}`, {
                                method: 'GET',
                                headers: { 
                                    'Accept': 'application/json',
                                    'User-Agent': 'Scoby/1.0',
                                    'Cache-Control': 'no-cache' 
                                }
                            });
                            if (!initialResponse.ok) throw new Error(`API request failed: ${initialResponse.status}`);
                            const channelData = await initialResponse.json();
                            const totalBlocks = channelData.length || 0;
                            const per = 50;
                            const totalPages = Math.max(1, Math.ceil(totalBlocks / per));
                            const pageNumbers = Array.from({ length: totalPages }, (_, i) => i + 1);
                            const requests = pageNumbers.map(pageNum => {
                                return fetch(`${api}${channelName}/contents?page=${pageNum}&per=${per}&direction=desc&sort=position`, {
                                    method: 'GET',
                                    headers: { 
                                        'Accept': 'application/json',
                                        'User-Agent': 'Scoby/1.0',
                                        'Cache-Control': 'no-cache' 
                                    }
                                }).then(r => {
                                    if (!r.ok) throw new Error(`API request failed: ${r.status}`);
                                    return r.json().then(data => ({ page: pageNum, data }));
                                });
                            });
                            const pages = await Promise.all(requests);
                            pages.sort((a, b) => a.page - b.page);
                            const seenIds = new Set();
                            pages.forEach(({ data }) => {
                                if (data && data.contents && data.contents.length) {
                                    data.contents.forEach(item => {
                                        if (item.class === 'Channel' && !seenIds.has(item.id)) {
                                            seenIds.add(item.id);
                                            allChannels.push(item);
                                        }
                                    });
                                }
                            });
                        }
                        
                        // Hide loading indicator and display initial set of channels
                        loadingEl.classList.add('done-loading');
                        displayChannels();
                        
                        // Show load more button if there are more channels to display
                        if (displayedCount < allChannels.length) {
                            loadMoreBtn.style.display = 'block';
                        }
                        
                    } catch (error) {
                        console.error('Error loading channels:', error);
                        loadingEl.textContent = 'Error loading channels. Please try again.';
                    }
                }
                
                function displayChannels() {
                    const startIndex = displayedCount;
                    const endIndex = Math.min(startIndex + perPage, allChannels.length);
                    
                    for (let i = startIndex; i < endIndex; i++) {
                        const channel = allChannels[i];
                        console.log(channel);
                        const link = `
                            <a href="${channel.slug}">
                                <b>${channel.title}</b> by ${channel.user.full_name}
                        `;
                        scobiesEl.insertAdjacentHTML('beforeend', link);
                    }
                    
                    displayedCount = endIndex;
                    
                    // Hide load more button if all channels are displayed
                    if (displayedCount >= allChannels.length) {
                        loadMoreBtn.style.display = 'none';
                    }
                }
                
                // Add click event for load more button
                loadMoreBtn.addEventListener('click', function() {
                    displayChannels();
                });
                
                // Refresh cache button
                const refreshBtn = document.getElementById('refresh-cache');
                refreshBtn.addEventListener('click', function() {
                    loadAllChannels(true, true);
                });
                
                // Start loading channels
                loadAllChannels(true);
            });
        </script>

    </body>
</html>
